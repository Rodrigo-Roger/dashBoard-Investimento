<!-- === PARTE 1/4 â€” CabeÃ§alho e estrutura base === -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MontInvestimento â€¢ Dashboard de ComissÃµes</title>
  <style>
    :root {
      --ms-navy: #0f2742;
      --ms-blue: #0f4c81;
      --ms-gold: #c6a224;
      --ms-ink: #122033;
      --ms-muted: #6b7280;
      --ms-bg: #f5f7fb;
      --ms-card: #ffffff;
      --ms-border: #e5e7eb;
      --radius: 16px;
      --shadow: 0 10px 25px rgba(15, 39, 66, .08);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--ms-ink);
      background: linear-gradient(180deg, #f8fafc 0%, var(--ms-bg) 100%);
    }

    .app { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
    @media (max-width: 980px) { .app { grid-template-columns: 1fr; } }

    /* Sidebar */
    .sidebar {
      background: linear-gradient(180deg, var(--ms-navy) 0%, #0b1b2e 100%);
      color: #e8eef7;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 36px; height: 36px; border-radius: 10px;
      background: radial-gradient(65% 65% at 30% 30%, #1e3b63 0%, var(--ms-blue) 65%, #0b1b2e 100%);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.05);
    }
    .brand h1 { font-size: 18px; margin: 0; font-weight: 700; }

    nav { display: flex; flex-direction: column; gap: 6px; margin-top: 6px; }
    .nav-btn {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 14px; border-radius: 12px;
      cursor: pointer; border: 1px solid transparent; transition: .2s;
    }
    .nav-btn:hover { background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.08); }
    .nav-btn.active { background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18); }

    .nav-foot { margin-top: auto; font-size: 12px; opacity: .8; }

    /* Main area */
    .main { padding: 28px; }
    .topbar {
      display: flex; flex-wrap: wrap; gap: 16px;
      align-items: center; justify-content: space-between;
      margin-bottom: 20px;
    }
    .title { font-size: 22px; font-weight: 800; }

    .pill {
      display: inline-flex; align-items: center; gap: 10px;
      padding: 8px 12px; border-radius: 999px;
      background: var(--ms-card); border: 1px solid var(--ms-border);
      box-shadow: var(--shadow);
    }

    /* Grid & Cards */
    .grid { display: grid; gap: 18px; }
    .grid.cols-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    @media (max-width: 1180px) { .grid.cols-3 { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 780px) { .grid.cols-3, .grid.cols-2 { grid-template-columns: 1fr; } }

    .card {
      background: var(--ms-card);
      border: 1px solid var(--ms-border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .kpi { display: flex; align-items: flex-end; justify-content: space-between; }
    .kpi .value { font-size: 28px; font-weight: 800; }

    /* Forms */
    label { display: block; font-size: 12px; color: var(--ms-muted); margin-bottom: 6px; }
    input, select {
      width: 100%; padding: 12px;
      border-radius: 12px; border: 1px solid var(--ms-border);
      background: #fff; font-size: 14px; outline: none;
    }
    input:focus, select:focus { border-color: #c7d2fe; box-shadow: 0 0 0 3px rgba(99,102,241,.12); }

    .btn {
      appearance: none; border: none; border-radius: 12px;
      padding: 12px 14px; font-weight: 700; cursor: pointer;
    }
    .btn.primary {
      background: linear-gradient(180deg, var(--ms-blue), #0b2f52);
      color: white; box-shadow: 0 8px 18px rgba(15,76,129,.28);
    }
    .btn.ghost { background: #fff; border: 1px solid var(--ms-border); }
    .btn.gold {
      background: linear-gradient(180deg, #f1d98a, var(--ms-gold));
      color: #1a1a1a; box-shadow: 0 8px 18px rgba(198,162,36,.25);
    }

    /* Progress bars */
    .progress { height: 10px; width: 100%; background: #eef2f7; border-radius: 999px; position: relative; overflow: hidden; }
    .progress > span { position: absolute; top: 0; left: 0; height: 100%; border-radius: 999px; background: linear-gradient(90deg, var(--ms-blue), #1f7fd1); }

    /* Tables */
    table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
    thead th {
      font-size: 12px; text-transform: uppercase;
      letter-spacing: .08em; color: var(--ms-muted);
      text-align: left; padding: 0 12px;
    }
    tbody td {
      background: #fff; border: 1px solid var(--ms-border);
      padding: 12px; vertical-align: middle;
    }
    tbody td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
    tbody td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; }

    .tag {
      font-size: 12px; padding: 6px 10px;
      border-radius: 999px; border: 1px solid var(--ms-border);
      background: #fff;
    }
    .tag.green { border-color: #cce3d1; background: #ecfdf5; }
    .tag.amber { border-color: #f6e7bf; background: #fffbea; }
    .tag.red { border-color: #f5c2c7; background: #fff1f2; }
    .tag.gray { border-color: #e5e7eb; background: #f9fafb; }

    .footnote { font-size: 12px; color: var(--ms-muted); }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <h1>MontInvestimento</h1>
      </div>
      <nav>
        <div class="nav-btn active" data-view="dashboard">ğŸ“Š Dashboard</div>
        <div class="nav-btn" data-view="vendas">ğŸ§¾ Vendas</div>
        <div class="nav-btn" data-view="pagamentos">ğŸ’° Pagamentos</div>
        <div class="nav-btn" data-view="estornos">â†©ï¸ Estornos</div>
        <div class="nav-btn" data-view="config">âš™ï¸ ConfiguraÃ§Ãµes</div>
      </nav>
      <div class="nav-foot">VersÃ£o multi-vendedor â€¢ Montseguro 2025</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">ComissÃµes & Metas</div>
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <div class="pill">
            <label for="filtro-vendedor">Vendedor:</label>
            <select id="filtro-vendedor"></select>
          </div>
          <div class="header-filters">
    <div class="filter-group">
        <label for="periodo">PerÃ­odo:</label>
        <select id="periodo">
            <option value="mensal">MÃªs Atual</option>
            <option value="personalizado">Personalizado</option> </select>
    </div>
</div>

<div id="custom-range" style="display: none; margin-top: 10px;">
    <div class="filter-group">
        <label for="data-inicio">InÃ­cio:</label>
        <input type="date" id="data-inicio" value="">
    </div>
    <div class="filter-group" style="margin-left: 10px;">
        <label for="data-fim">Fim:</label>
        <input type="date" id="data-fim" value="">
    </div>
</div>
        </div>
      </div>

      <!-- === PARTE 2/4 â€” SeÃ§Ãµes principais do painel === -->

      <!-- === PAINEL FINANCEIRO (CABEÃ‡ALHO DE KPIs) === -->
      <div class="grid cols-3" style="margin-bottom:18px">
        <div class="card kpi">
          <div><h3>ğŸ’µ SalÃ¡rio Fixo</h3><div class="muted">Base mensal</div></div>
          <div class="value" id="salario-fixo">R$ 6.000,00</div>
        </div>
        <div class="card kpi">
          <div><h3>ğŸ’° ComissÃ£o do MÃªs</h3><div class="muted">Parcelas pagas</div></div>
          <div class="value" id="comissao-mes">R$ 0,00</div>
        </div>
        <div class="card kpi">
          <div><h3>ğŸ” Estornos</h3><div class="muted">Cancelamentos do mÃªs</div></div>
          <div class="value" id="estornos-mes">R$ 0,00</div>
        </div>
      </div>

      <div class="card kpi" style="background:linear-gradient(180deg,#e0f2fe,#bae6fd);margin-bottom:24px">
        <div><h3>ğŸ§¾ SalÃ¡rio Final do MÃªs</h3><div class="muted">Fixo + ComissÃ£o - Estornos</div></div>
        <div class="value" id="salario-final">R$ 6.000,00</div>
      </div>

      <!-- ===== DASHBOARD ===== -->
      <section id="view-dashboard" class="view">
        <div class="grid cols-3">
          <div class="card kpi">
            <div>
              <h3>SalÃ¡rio Fixo</h3>
              <div class="muted" id="kpi-legenda-fixo">base mensal</div>
            </div>
            <div class="value" id="kpi-fixo">R$ 6.000,00</div>
          </div>
          <div class="card kpi">
            <div>
              <h3>Total Vendido</h3>
              <div class="muted" id="kpi-legenda-vendas">no mÃªs atual</div>
            </div>
            <div class="value" id="kpi-vendas">R$ 0,00</div>
          </div>
          <div class="card kpi">
            <div>
              <h3>ComissÃ£o</h3>
              <div class="muted" id="kpi-legenda-comissao">alÃ­quota dinÃ¢mica</div>
            </div>
            <div class="value" id="kpi-comissao">R$ 0,00</div>
          </div>
        </div>

        <div class="grid cols-2" style="margin-top:18px">
          <div class="card">
            <h3>Metas do PerÃ­odo</h3>
            <div class="row">
              <div>
                <div class="muted">Meta 01 â€” 0,2% a partir de R$ 2.000.000,00</div>
                <div class="progress" style="margin-top:8px"><span id="bar-m1" style="width:0%"></span></div>
              </div>
              <div style="text-align:right"><span class="tag" id="tag-m1">0%</span></div>
            </div>
            <div class="row" style="margin-top:12px">
              <div>
                <div class="muted">Meta 02 â€” 0,3% a partir de R$ 3.000.000,00</div>
                <div class="progress" style="margin-top:8px"><span id="bar-m2" style="width:0%"></span></div>
              </div>
              <div style="text-align:right"><span class="tag" id="tag-m2">0%</span></div>
            </div>
            <div class="row" style="margin-top:12px">
              <div>
                <div class="muted">Meta 03 â€” 0,3% a partir de R$ 4.000.000,00</div>
                <div class="progress" style="margin-top:8px"><span id="bar-m3" style="width:0%"></span></div>
              </div>
              <div style="text-align:right"><span class="tag" id="tag-m3">0%</span></div>
            </div>
          </div>

          <div class="card">
            <h3>ProgressÃ£o de Cargo</h3>
            <p class="muted">ManutenÃ§Ã£o Pleno â‰¥ R$ 7.500.000,00 no trimestre â€¢ PromoÃ§Ã£o para SÃªnior â‰¥ R$ 15.000.000,00 no trimestre</p>
            <div class="row" style="margin-top:10px">
              <div>
                <div class="muted">Manter Pleno</div>
                <div class="progress" style="margin-top:8px"><span id="bar-pleno" style="width:0%"></span></div>
              </div>
              <div style="text-align:right"><span class="tag" id="tag-pleno">0%</span></div>
            </div>
            <div class="row" style="margin-top:12px">
              <div>
                <div class="muted">Virar SÃªnior</div>
                <div class="progress" style="margin-top:8px"><span id="bar-senior" style="width:0%"></span></div>
              </div>
              <div style="text-align:right"><span class="tag" id="tag-senior">0%</span></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <h3>Resumo do PerÃ­odo</h3>
          <div class="grid cols-3">
            <div>
              <div class="muted">AlÃ­quota aplicada</div>
              <div class="value" id="aliquota">0,00%</div>
            </div>
            <div>
              <div class="muted">ComissÃ£o estimada</div>
              <div class="value" id="comissao">R$ 0,00</div>
            </div>
            <div>
              <div class="muted">Total (fixo + comissÃ£o)</div>
              <div class="value" id="total">R$ 6.000,00</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== VENDAS ===== -->
      <section id="view-vendas" class="view" style="display:none">
        <div class="card">
          <h3>Adicionar Venda</h3>
          <div class="row-3">
            <div>
              <label>Cliente</label>
              <input id="cliente" placeholder="Ex.: ACME Ltda" />
            </div>
            <div>
              <label>Valor do contrato (R$)</label>
              <input id="valor" type="number" min="0" step="0.01" placeholder="0,00" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <label>Data (1Âª parcela do cliente)</label>
              <input id="data" type="date" />
            </div>
          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn primary" id="btn-add">Adicionar</button>
            <button class="btn ghost" id="btn-sample">Carregar exemplo</button>
            <button class="btn ghost" id="btn-limpar">Limpar vendas</button>
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <h3>Vendas do perÃ­odo</h3>
          <table id="tabela-vendas">
    <thead>
        <tr>
            <th>Cliente</th> 
            <th>Data</th>    
            <th>Valor</th>   
            <th>Status</th>  
            <th style="text-align:right">AÃ§Ã£o</th> </tr>
    </thead>
    <tbody id="tbody-vendas">
    </tbody>
</table>
          <div class="footnote">Obs.: A comissÃ£o de cada venda Ã© paga em <b>6 parcelas mensais</b> no dia 10.</div>
        </div>
      </section>

      <!-- ===== PAGAMENTOS ===== -->
      <section id="view-pagamentos" class="view" style="display:none">
        <div class="card">
          <h3>Resumo de Pagamentos</h3>
          <div class="grid cols-3">
            <div><div class="muted">Pagos</div><div class="value" id="pg-pagos">R$ 0,00</div></div>
            <div><div class="muted">Agendados</div><div class="value" id="pg-agendados">R$ 0,00</div></div>
          </div>

          <div class="grid cols-3" style="margin-top:12px">
            <div><div class="muted">Estornos</div><div class="value" id="pg-estornos">R$ 0,00</div></div>
            <div><div class="muted">LÃ­quido</div><div class="value" id="pg-liquido">R$ 0,00</div></div>
            <div><div class="muted">PrÃ³ximo ciclo</div><div class="value" id="pg-proximo">â€”</div></div>
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <div class="filter-group" style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Cronograma de ComissÃµes</h3>
            
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="filtro-cronograma">Visualizar MÃªs:</label>
                <select id="filtro-cronograma">
                </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Cliente</th>
                <th>MÃªs ref.</th>
                <th>Status</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="tbody-pagamentos"></tbody>
          </table>
        </div>
      </section>

      <!-- ===== ESTORNOS ===== -->
      <section id="view-estornos" class="view" style="display:none">
        <div class="card">
          <h3>PolÃ­tica de Estorno</h3>
          <p class="muted">Cancelamento com menos de 5 parcelas pagas gera estorno das comissÃµes jÃ¡ pagas, mÃªs a mÃªs. Se o cliente pagou 5+, nÃ£o hÃ¡ estorno e a 6Âª Ã© paga normalmente.</p>
        </div>

        <div class="card" style="margin-top:18px">
          <h3>Estornos AutomÃ¡ticos</h3>
          <table>
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Status</th>
                <th>Motivo</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="tbody-estornos"></tbody>
          </table>
          <div class="kpi" style="margin-top:12px">
            <div class="muted">Total de Estornos</div>
            <div class="value" id="estorno-total">R$ 0,00</div>
          </div>
        </div>
      </section>

      <!-- === PARTE 3/4 â€” ConfiguraÃ§Ã£o e gerenciamento de vendedores === -->

      <!-- ===== CONFIGURAÃ‡Ã•ES ===== -->
      <section id="view-config" class="view" style="display:none">
        <div class="card">
          <h3>ParÃ¢metros Gerais</h3>
          <div class="row-3">
            <div>
              <label>SalÃ¡rio fixo (R$/mÃªs)</label>
              <input id="cfg-fixo" type="number" min="0" step="0.01" value="6000" />
            </div>
            <div>
              <label>Meta 01 (R$)</label>
              <input id="cfg-m1" type="number" min="0" step="1000" value="2000000" />
            </div>
            <div>
              <label>Aliq. Meta 01 (%)</label>
              <input id="cfg-a1" type="number" min="0" step="0.01" value="0.2" />
            </div>
          </div>

          <div class="row-3" style="margin-top:12px">
            <div>
              <label>Meta 02 (R$)</label>
              <input id="cfg-m2" type="number" min="0" step="1000" value="3000000" />
            </div>
            <div>
              <label>Aliq. Meta 02 (%)</label>
              <input id="cfg-a2" type="number" min="0" step="0.01" value="0.3" />
            </div>
            <div>
              <label>Meta 03 (R$)</label>
              <input id="cfg-m3" type="number" min="0" step="1000" value="4000000" />
            </div>
          </div>

          <div class="row-3" style="margin-top:12px">
            <div>
              <label>Aliq. Meta 03 (%)</label>
              <input id="cfg-a3" type="number" min="0" step="0.01" value="0.3" />
            </div>
            <div>
              <label>Trimestre: Manter Pleno (R$)</label>
              <input id="cfg-pleno" type="number" min="0" step="1000" value="7500000" />
            </div>
            <div>
              <label>Trimestre: Virar SÃªnior (R$)</label>
              <input id="cfg-senior" type="number" min="0" step="1000" value="15000000" />
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn primary" id="btn-salvar">Salvar</button>
            <button class="btn ghost" id="btn-resetar">Resetar padrÃµes</button>
          </div>
        </div>

        <!-- NOVO BLOCO: GERENCIAMENTO DE VENDEDORES -->
        <div class="card" style="margin-top:18px">
          <h3>Perfis de Vendedores</h3>
          <p class="muted">Cada vendedor tem vendas, metas e estornos prÃ³prios. Escolha o vendedor ativo para atualizar os dados exibidos no dashboard.</p>

          <div class="row">
            <div>
              <label>Selecionar vendedor ativo</label>
              <select id="select-vendedor"></select>
            </div>
            <div>
              <label>Nome do novo vendedor</label>
              <input id="novo-vendedor" type="text" placeholder="Ex.: JoÃ£o Silva" />
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn primary" id="btn-add-vendedor">Criar vendedor</button>
            <button class="btn gold" id="btn-ativar-vendedor">Ativar selecionado</button>
            <button class="btn ghost" id="btn-remover-vendedor">Excluir selecionado</button>
          </div>

          <div class="footnote" style="margin-top:8px">
            â€¢ Ao ativar um vendedor, o dashboard mostrarÃ¡ apenas suas vendas, comissÃµes e estornos.  
            â€¢ O vendedor <b>Angelo</b> (Pleno) Ã© criado automaticamente como perfil padrÃ£o.
          </div>
        </div>
      </section>

      <!-- FIM DAS SEÃ‡Ã•ES PRINCIPAIS -->
    </main>
  </div>

  <!-- Script vem na parte 4 -->

  <!-- === PARTE 4/4 â€” Script completo (multi-vendedor + perÃ­odo + estornos) === -->
<script>
const fmtBRL = v => (Number(v)||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
const pct = v => `${(v*100).toFixed(2).replace('.',',')}%`;
const parseISO = s => s ? new Date(s + 'T00:00:00') : null;
const DIA_PAGAMENTO = 10;

const structuredClone = (obj) => JSON.parse(JSON.stringify(obj)); 

const baseCfg = {
Â  fixo: 6000,
Â  metas: [
Â  Â  { alvo: 2000000, aliq: 0.002 }, 
Â  Â  { alvo: 3000000, aliq: 0.003 }, 
Â  Â  { alvo: 4000000, aliq: 0.003 }, 
Â  ],
Â  pleno: 7500000,
Â  senior: 15000000,
};

const STORAGE_KEY = 'ms-multi-vendedores-2025';

const state = {
Â  vendedores: [],
Â  ativo: null, Â  Â  Â  
Â  periodo: 'mensal', 
Â  dataInicio: null, 
Â  dataFim: null,
Â  filtroCronograma: null, 
};

function save() {
Â  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function load() {
Â  const raw = localStorage.getItem(STORAGE_KEY);
Â  if (!raw) {
Â  Â  const angelo = {
Â  Â  Â  id: crypto.randomUUID(),
Â  Â  Â  nome: 'Angelo',
Â  Â  Â  nivel: 'Pleno',
Â  Â  Â  cfg: structuredClone(baseCfg),
Â  Â  Â  vendas: []
Â  Â  };
Â  Â  state.vendedores = [angelo];
Â  Â  state.ativo = angelo.id;
Â  Â  state.periodo = 'mensal';
Â  Â  
Â  Â  const hoje = new Date();
Â  Â  state.filtroCronograma = `${hoje.getFullYear()}-${hoje.getMonth()}`; 
Â  Â  
Â  Â  state.dataInicio = null;
Â  Â  state.dataFim = null;
Â  Â  
Â  Â  save();
Â  Â  return;
Â  }
Â  try {
Â  Â  const s = JSON.parse(raw);
Â  Â  if (!Array.isArray(s.vendedores) || !s.vendedores.length) {
Â  Â  Â  const angelo = {
Â  Â  Â  Â  id: crypto.randomUUID(),
Â  Â  Â  Â  nome: 'Angelo',
Â  Â  Â  Â  nivel: 'Pleno',
Â  Â  Â  Â  cfg: structuredClone(baseCfg),
Â  Â  Â  Â  vendas: []
Â  Â  Â  };
Â  Â  Â  state.vendedores = [angelo];
Â  Â  Â  state.ativo = angelo.id;
Â  Â  Â  state.periodo = 'mensal';
Â  Â  } else {
Â  Â  Â  Object.assign(state, s);
Â  Â  }
Â  Â  
Â  Â  if (!state.filtroCronograma) {
Â  Â  Â  const hoje = new Date();
Â  Â  Â  state.filtroCronograma = `${hoje.getFullYear()}-${hoje.getMonth()}`;
Â  Â  }
Â  Â  if (state.periodo === 'trimestral') state.periodo = 'mensal';
Â  Â  if (state.dataInicio === undefined) state.dataInicio = null;
Â  Â  if (state.dataFim === undefined) state.dataFim = null;
Â  Â  
Â  } catch(e) {
Â  Â  console.error(e);
Â  }
}

const byId = id => state.vendedores.find(v => v.id === id) || null;

function getScopeFromUI() {
Â  const sel = document.getElementById('filtro-vendedor');
Â  return sel?.value || 'todos';
}

function getScopeVendas(scope) {
Â  if (scope === 'todos') {
Â  Â  return state.vendedores.flatMap(v => v.vendas.map(x => ({...x, _owner:v.id})));
Â  }
Â  const vend = byId(scope);
Â  return vend ? vend.vendas.map(x => ({...x, _owner: vend.id})) : [];
}

function getPeriodoInterval() {
Â  const hoje = new Date();
Â  
Â  const fimPadrao = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate() + 1, 0, 0, 0, 0); 

Â  if (state.periodo === 'personalizado' && state.dataInicio && state.dataFim) {
Â  Â  const inicio = parseISO(state.dataInicio);
Â  Â  const fimPersonalizado = new Date(parseISO(state.dataFim));
Â  Â  fimPersonalizado.setDate(fimPersonalizado.getDate() + 1);
Â  Â  
Â  Â  if(inicio && fimPersonalizado){
Â  Â  Â  return { inicio, fim: fimPersonalizado };
Â  Â  }
Â  } 
Â  
Â  const inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1, 0, 0, 0, 0);
Â  return { inicio, fim: fimPadrao };
}

function filtrarVendasPorPeriodo(vendas) {
Â  const { inicio, fim } = getPeriodoInterval();
Â  if (!inicio || !fim) return vendas; 
Â  
Â  return vendas.filter(v => {
Â  Â  const d = parseISO(v.data);
Â  Â  return d && d >= inicio && d <= fim;
Â  });
}

function totalVendido(vendas) {
Â  return vendas.reduce((acc, v) => acc + Number(v.valor||0), 0);
}

function aliquotaAplicavel(total, metas) {
Â  let aliq = 0;
Â  if (total >= metas[2].alvo) aliq = metas[2].aliq; 
Â  else if (total >= metas[1].alvo) aliq = metas[1].aliq;
Â  else if (total >= metas[0].alvo) aliq = metas[0].aliq;
Â  return aliq;
}

function dataComissaoParcela(venda, i){
Â  const start = parseISO(venda.data) || new Date();
Â  const d = new Date(start);
Â  d.setMonth(d.getMonth() + i);
Â  d.setDate(DIA_PAGAMENTO);
Â  return d;
}

function expectedClientePagasAte(venda, refDate){
Â  const start = parseISO(venda.data) || new Date();
Â  const vencDia = start.getDate();
Â  let count = 0;
Â  for(let k=0; k<venda.parcelas; k++){
Â  Â  const due = new Date(start);
Â  Â  due.setMonth(due.getMonth() + k);
Â  Â  due.setDate(vencDia);
Â  Â  if(due <= refDate) count++;
Â  }
Â  return count;
}

function cronogramaComissaoVenda(venda, comissaoVenda){
Â  const today = new Date();
Â  const cancelAt = venda.status === 'cancelado' && venda.cancelamento ? parseISO(venda.cancelamento) : null;
Â  const pagasCliente = Number(venda.pagas||0);
Â  const parcelas = [];

Â  for(let i=1;i<=6;i++){
Â  Â  const when = dataComissaoParcela(venda, i);
Â  Â  let status = 'agendado';

Â  Â  if(cancelAt && cancelAt <= when){
Â  Â  Â  if(pagasCliente >= 5){
Â  Â  Â  Â  status = (when <= today) ? 'pago' : 'agendado';
Â  Â  Â  } else {
Â  Â  Â  Â  status = 'cancelado';
Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  if(when <= today){
Â  Â  Â  Â  const esperadas = expectedClientePagasAte(venda, when);
Â  Â  Â  Â  const inadimplente = (Number(venda.pagas||0) < Math.min(esperadas, venda.parcelas));
Â  Â  Â  Â  
Â  Â  Â  Â  if(inadimplente && pagasCliente < 5){
Â  Â  Â  Â  Â  status = 'inadimplente'; 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  status = 'pago'; 
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  status = 'agendado';
Â  Â  Â  }
Â  Â  }

Â  Â  let statusFinal = status;
Â  Â  if (venda.cronograma_manual && venda.cronograma_manual[i-1]) {
Â  Â  Â  statusFinal = venda.cronograma_manual[i-1];
Â  Â  Â  if (statusFinal === 'suspenso') statusFinal = 'inadimplente';
Â  Â  }

Â  Â  parcelas.push({ data: when, status: statusFinal, valor: comissaoVenda/6 });
Â  }
Â  return parcelas;
}

function gerarEstornosPosCancelamento(venda, cronograma){
Â  const estornos = [];
Â  if(venda.status !== 'cancelado' || !venda.cancelamento) return estornos;

Â  const pagasCliente = Number(venda.pagas||0);
Â  if(pagasCliente >= 5) return estornos;

Â  const cancelAt = parseISO(venda.cancelamento);
Â  const pagasAntes = cronograma.filter(p => p.status === 'pago' && p.data < cancelAt);
Â  if(pagasAntes.length === 0) return estornos;

Â  const start = new Date(cancelAt);
Â  if(start.getDate() > DIA_PAGAMENTO){ start.setMonth(start.getMonth()+1); }
Â  start.setDate(DIA_PAGAMENTO);

Â  for(let i=0;i<pagasAntes.length;i++){
Â  Â  const d = new Date(start);
Â  Â  d.setMonth(d.getMonth()+i);
Â  Â  estornos.push({ data: d, status: 'estorno', valor: pagasAntes[0].valor });
Â  }
Â  return estornos;
}

function generateMonthOptions() {
Â  const sel = document.getElementById('filtro-cronograma');
Â  if (!sel) return;

Â  sel.innerHTML = '';
Â  
Â  const hoje = new Date();
Â  const mesAtual = hoje.getMonth();
Â  const anoAtual = hoje.getFullYear();
Â  
Â  for (let i = -12; i <= 12; i++) { 
Â  Â  const d = new Date(anoAtual, mesAtual + i, 1);
Â  Â  const mes = d.getMonth();
Â  Â  const ano = d.getFullYear();
Â  Â  const value = `${ano}-${mes}`; 
Â  Â  
Â  Â  const opt = document.createElement('option');
Â  Â  opt.value = value;
Â  Â  opt.textContent = d.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
Â  Â  sel.appendChild(opt);
Â  }
Â  
Â  sel.value = state.filtroCronograma;
Â  
Â  sel.onchange = (e) => {
Â  Â  state.filtroCronograma = e.target.value;
Â  Â  save();
Â  Â  calcular(getScopeFromUI());
Â  };
}

function renderTopDropdowns() {
Â  const sel = document.getElementById('filtro-vendedor');
Â  if (!sel) return;
Â  const current = sel.value || 'todos';
Â  sel.innerHTML = '';
Â  const optAll = document.createElement('option');
Â  optAll.value = 'todos';
Â  optAll.textContent = 'Todos (geral)';
Â  sel.appendChild(optAll);

Â  state.vendedores.forEach(v => {
Â  Â  const o = document.createElement('option');
Â  Â  o.value = v.id;
Â  Â  o.textContent = `${v.nome} (${v.nivel})`;
Â  Â  sel.appendChild(o);
Â  });

Â  sel.value = current;
Â  if (!sel.value) sel.value = 'todos';

Â  const selCfg = document.getElementById('select-vendedor');
Â  if (selCfg) {
Â  Â  selCfg.innerHTML = '';
Â  Â  state.vendedores.forEach(v => {
Â  Â  Â  const o = document.createElement('option');
Â  Â  Â  o.value = v.id;
Â  Â  Â  o.textContent = `${v.nome} (${v.nivel})`;
Â  Â  Â  selCfg.appendChild(o);
Â  Â  });
Â  Â  selCfg.value = state.ativo || (state.vendedores[0]?.id || '');
Â  }
Â  
Â  generateMonthOptions();
}

function renderVendasTable(vendasEscopo) {
Â  const tbody = document.getElementById('tbody-vendas');
Â  if(!tbody) return;
Â  tbody.innerHTML = '';

Â  const vendasPeriodo = filtrarVendasPorPeriodo(vendasEscopo); 
Â  
Â  vendasPeriodo.forEach((v, idx) => {
Â  Â  const tr = document.createElement('tr');
Â  Â  tr.innerHTML = `
Â  Â  Â  <td>${v.cliente||'-'}</td>
Â  Â  Â  <td>${v.data||'-'}</td>
Â  Â  Â  <td><b>${fmtBRL(Number(v.valor||0))}</b></td>
Â  Â  Â  <td>${v.status||'ativo'}</td>
Â  Â  Â  <td style="text-align:right"><button class="btn gold" data-del="${idx}">Excluir</button></td>
Â  Â  `;
Â  Â  tbody.appendChild(tr);
Â  });

Â  tbody.querySelectorAll('button[data-del]').forEach((btn, visualIdx) => {
Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  const scope = getScopeFromUI();
Â  Â  Â  if (scope === 'todos') {
Â  Â  Â  Â  alert('Troque o filtro para um vendedor especÃ­fico para excluir vendas.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const vend = byId(scope);
Â  Â  Â  if (!vend) return;
Â  Â  Â  const vendasVisuais = filtrarVendasPorPeriodo(vend.vendas); 
Â  Â  Â  const vendaVisual = vendasVisuais[visualIdx];
Â  Â  Â  if (!vendaVisual) return;
Â  Â  Â  
Â  Â  Â  const idxReal = vend.vendas.findIndex(x =>
Â  Â  Â  Â  x.cliente===vendaVisual.cliente &&
Â  Â  Â  Â  x.data===vendaVisual.data &&
Â  Â  Â  Â  x.valor===vendaVisual.valor 
Â  Â  Â  );
Â  Â  Â  if (idxReal>=0) {
Â  Â  Â  Â  vend.vendas.splice(idxReal,1);
Â  Â  Â  }
Â  Â  Â  save();
Â  Â  Â  calcular(scope);
Â  Â  });
Â  });
}

function renderPagamentosEEstornos(scope, metasRef) {
Â  const tbPay = document.getElementById('tbody-pagamentos');
Â  const tbEst = document.getElementById('tbody-estornos');
Â  const lblEPagos = document.getElementById('pg-pagos');
Â  const lblEInad = document.getElementById('pg-inadimplentes'); 
Â  const lblEAgend = document.getElementById('pg-agendados');
Â  const lblEEst = document.getElementById('pg-estornos');
Â  const lblELiq = document.getElementById('pg-liquido');
Â  const lblNext = document.getElementById('pg-proximo');
Â  const lblEstTotal = document.getElementById('estorno-total');

Â  if (tbPay) tbPay.innerHTML = '';
Â  if (tbEst) tbEst.innerHTML = '';

Â  const [anoFiltro, mesFiltro] = state.filtroCronograma.split('-').map(Number);
Â  
Â  const vendasEscopo = getScopeVendas(scope);
Â  const totalVendasDoEscopo = totalVendido(vendasEscopo); 
Â  const aliqDoEscopo = aliquotaAplicavel(totalVendasDoEscopo, metasRef);
Â  const comissaoTotalDoEscopo = totalVendasDoEscopo * aliqDoEscopo;

Â  let somaPagos = 0, somaInadimplentes = 0, somaAgendados = 0, somaEstornos = 0;

Â  const hoje = new Date(); 
Â  const mesAtual = hoje.getMonth();
Â  const anoAtual = hoje.getFullYear();

Â  let comissaoMesKPI = 0; 
Â  let estornosMesKPI = 0; 

Â  vendasEscopo.forEach((v, vIdx) => {
Â  Â  const peso = totalVendasDoEscopo > 0 ? (Number(v.valor || 0) / totalVendasDoEscopo) : 0;
Â  Â  const comissaoVenda = comissaoTotalDoEscopo * peso;
Â  Â  
Â  Â  const cron = cronogramaComissaoVenda(v, comissaoVenda);
Â  Â  const est = gerarEstornosPosCancelamento(v, cron);

Â  Â  cron.forEach(p => {
Â  Â  Â  const ehMesAtual = p.data.getMonth() === mesAtual && p.data.getFullYear() === anoAtual;
Â  Â  Â  if (ehMesAtual && (p.status === 'pago' || p.status === 'agendado')) { 
Â  Â  Â  Â  comissaoMesKPI += p.valor;
Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  est.forEach(ei => {
Â  Â  Â  const ehMesAtual = ei.data.getMonth() === mesAtual && ei.data.getFullYear() === anoAtual;
Â  Â  Â  if (ehMesAtual) estornosMesKPI += ei.valor;
Â  Â  });

Â  Â  if (tbPay){
Â  Â  Â  cron.forEach((p, i)=>{
Â  Â  Â  Â  const ehMesSelecionado = p.data.getMonth() === mesFiltro && p.data.getFullYear() === anoFiltro;
Â  Â  Â  Â  const statusRelevante = (p.status !== 'cancelado'); 

Â  Â  Â  Â  if (!ehMesSelecionado || !statusRelevante) {
Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  }

Â  Â  Â  Â  if(p.status==='pago'){ somaPagos += p.valor; }
Â  Â  Â  Â  if(p.status==='inadimplente'){ somaInadimplentes += p.valor; } 
Â  Â  Â  Â  if(p.status==='agendado'){ somaAgendados += p.valor; }

Â  Â  Â  Â  const statusSelect = `
Â  Â  Â  Â  Â  Â  <select class="status-select" data-venda-idx="${vIdx}" data-parcela-idx="${i}">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="pago" ${p.status === 'pago' ? 'selected' : ''}>Pago</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="agendado" ${p.status === 'agendado' ? 'selected' : ''}>Agendado</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="inadimplente" ${p.status === 'inadimplente' ? 'selected' : ''}>Inadimplente</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="cancelado" ${p.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  `;

Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  <td>${v.cliente||'-'}</td>
Â  Â  Â  Â  Â  <td>${p.data.toLocaleDateString('pt-BR', {month:'2-digit', year:'numeric'})}</td>
Â  Â  Â  Â  Â  <td>${statusSelect}</td> 
Â  Â  Â  Â  Â  <td class="valor"><b>${fmtBRL(p.valor)}</b></td>
Â  Â  Â  Â  `;
Â  Â  Â  Â  tbPay.appendChild(tr);
Â  Â  Â  });
Â  Â  }

Â  Â  if (tbEst && est.length){
Â  Â  Â  est.forEach(ei=>{
Â  Â  Â  Â  const ehMesSelecionado = ei.data.getMonth() === mesFiltro && ei.data.getFullYear() === anoFiltro;
Â  Â  Â  Â  
Â  Â  Â  Â  if (!ehMesSelecionado) return;
Â  Â  Â  Â  
Â  Â  Â  Â  somaEstornos += ei.valor;
Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  <td>${v.cliente||'-'}</td>
Â  Â  Â  Â  Â  <td>${parseISO(v.cancelamento).toLocaleDateString('pt-BR')}</td>
Â  Â  Â  Â  Â  <td><span class="tag red">Estorno</span></td>
Â  Â  Â  Â  Â  <td class="valor"><b>${fmtBRL(ei.valor)}</b></td>
Â  Â  Â  Â  `;
Â  Â  Â  Â  tbEst.appendChild(tr);
Â  Â  Â  });
Â  Â  }

Â  });

Â  const proximo10 = (() => {
Â  Â  const t = new Date();
Â  Â  if(t.getDate() > DIA_PAGAMENTO){ t.setMonth(t.getMonth()+1); }
Â  Â  t.setDate(DIA_PAGAMENTO);
Â  Â  return t;
Â  })();

Â  if(lblEPagos) lblEPagos.textContent = fmtBRL(somaPagos);
Â  if(lblEInad) lblEInad.textContent = fmtBRL(somaInadimplentes); 
Â  if(lblEAgend) lblEAgend.textContent = fmtBRL(somaAgendados);
Â  if(lblEEst) lblEEst.textContent = fmtBRL(somaEstornos);
Â  if(lblELiq) lblELiq.textContent = fmtBRL(Math.max(0, somaPagos + somaAgendados - somaEstornos)); 
Â  if(lblNext) lblNext.textContent = proximo10.toLocaleDateString('pt-BR');
Â  if(lblEstTotal) lblEstTotal.textContent = fmtBRL(somaEstornos);
Â  
Â  document.getElementById('comissao-mes').textContent = fmtBRL(comissaoMesKPI);
Â  document.getElementById('estornos-mes').textContent = fmtBRL(estornosMesKPI);

Â  let salarioFixo = 0;
Â  if (scope === 'todos') salarioFixo = state.vendedores.reduce((acc,v)=>acc+(Number(v.cfg?.fixo)||0),0);
Â  else salarioFixo = Number(byId(scope)?.cfg?.fixo) || 0;

Â  const salarioFinal = salarioFixo + comissaoMesKPI - estornosMesKPI;

Â  document.getElementById('salario-fixo').textContent = fmtBRL(salarioFixo);
Â  document.getElementById('salario-final').textContent = fmtBRL(salarioFinal);
Â  Â 
Â  Â  if (tbPay) {
Â  Â  Â  tbPay.querySelectorAll('.status-select').forEach(select => {
Â  Â  Â  Â  Â  select.addEventListener('change', (e) => {
Â  Â  Â  Â  Â  Â  Â  const novoStatus = e.target.value;
Â  Â  Â  Â  Â  Â  Â  const parcelaIdx = parseInt(e.target.dataset.parcelaIdx); 
Â  Â  Â  Â  Â  Â  Â  const visualIdx = parseInt(e.target.dataset.vendaIdx); 
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  const vendaAfetada = vendasEscopo[visualIdx]; 
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  if (!vendaAfetada) return;
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  const vendOwner = byId(vendaAfetada._owner);
Â  Â  Â  Â  Â  Â  Â  const realIndex = vendOwner.vendas.findIndex(v => v.cliente === vendaAfetada.cliente && v.data === vendaAfetada.data);
Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  if (realIndex >= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const vendaNoState = vendOwner.vendas[realIndex];
Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!vendaNoState.cronograma_manual) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cronAuto = cronogramaComissaoVenda(vendaNoState, 1); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  vendaNoState.cronograma_manual = cronAuto.map(p => p.status === 'suspenso' ? 'inadimplente' : p.status);
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  vendaNoState.cronograma_manual[parcelaIdx] = novoStatus;
Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  save();
Â  Â  Â  Â  Â  Â  Â  Â  Â  calcular(getScopeFromUI());
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }
}

function renderDashboard(scope) {
Â  const vendasEscopo = getScopeVendas(scope);
Â  const vendasPeriodo = filtrarVendasPorPeriodo(vendasEscopo); 

Â  let cfgRef = structuredClone(baseCfg);
Â  if (scope !== 'todos') {
Â  Â  const vend = byId(scope);
Â  Â  if (vend) cfgRef = vend.cfg || structuredClone(baseCfg);
Â  }

Â  const total = totalVendido(vendasPeriodo);
Â  const aliq = aliquotaAplicavel(total, cfgRef.metas);
Â  const comissaoTotal = total * aliq;

Â  const fixo = (scope==='todos')
Â  Â  ? state.vendedores.reduce((acc,v)=>acc+(Number(v.cfg?.fixo)||0),0)
Â  Â  : Number(byId(scope)?.cfg?.fixo) || baseCfg.fixo;

Â  document.getElementById('kpi-vendas').textContent = fmtBRL(total);
Â  document.getElementById('kpi-comissao').textContent = fmtBRL(comissaoTotal);
Â  document.getElementById('kpi-fixo').textContent = fmtBRL(fixo);
Â  
Â  let legenda = 'no perÃ­odo atual';
Â  if (state.periodo === 'mensal') legenda = 'no MÃªs Atual';
Â  else if (state.periodo === 'personalizado') legenda = 'no PerÃ­odo Personalizado';
Â  document.getElementById('kpi-legenda-vendas').textContent = legenda;
Â  
Â  document.getElementById('kpi-legenda-comissao').textContent = aliq? `alÃ­quota ${pct(aliq)}`:'sem meta atingida';
Â  document.getElementById('kpi-legenda-fixo').textContent = scope==='todos' ? 'soma dos fixos' : 'base mensal';

Â  const metas = cfgRef.metas;
Â  const bars = ['bar-m1','bar-m2','bar-m3'];
Â  const tags = ['tag-m1','tag-m2','tag-m3'];
Â  metas.forEach((m, i) => {
Â  Â  const perc = m.alvo>0 ? Math.min(100, Math.round((total / m.alvo) * 100)) : 0;
Â  Â  const bar = document.getElementById(bars[i]);
Â  Â  const tag = document.getElementById(tags[i]);
Â  Â  if (bar) bar.style.width = perc + '%';
Â  Â  if (tag) {
Â  Â  Â  tag.textContent = perc + '%';
Â  Â  Â  tag.className = 'tag ' + (perc>=100? 'green': (perc>=50?'amber':'')) || 'tag';
Â  Â  }
Â  });

Â  const ref = total;
Â  const plenoPerc = cfgRef.pleno>0 ? Math.min(100, Math.round((ref / cfgRef.pleno) * 100)) : 0;
Â  const seniorPerc = cfgRef.senior>0 ? Math.min(100, Math.round((ref / cfgRef.senior) * 100)) : 0;
Â  document.getElementById('bar-pleno').style.width = plenoPerc + '%';
Â  document.getElementById('tag-pleno').textContent = plenoPerc + '%';
Â  document.getElementById('tag-pleno').className = 'tag ' + (plenoPerc>=100?'green': (plenoPerc>=50?'amber':'')) || 'tag';
Â  document.getElementById('bar-senior').style.width = seniorPerc + '%';
Â  document.getElementById('tag-senior').textContent = seniorPerc + '%';
Â  document.getElementById('tag-senior').className = 'tag ' + (seniorPerc>=100?'green': (seniorPerc>=50?'amber':'')) || 'tag';

Â  document.getElementById('aliquota').textContent = pct(aliq||0);
Â  document.getElementById('comissao').textContent = fmtBRL(comissaoTotal);

Â  const totalFixo = (scope==='todos')
Â  Â  ? state.vendedores.reduce((acc,v)=>acc+(Number(v.cfg?.fixo)||0),0)
Â  Â  : Number(byId(scope)?.cfg?.fixo) || 0;
Â  document.getElementById('total').textContent = fmtBRL(totalFixo + comissaoTotal);

Â  renderVendasTable(vendasEscopo); 
Â  renderPagamentosEEstornos(scope, cfgRef.metas);
}

function bindCfgInputsFromActive() {
Â  const vend = byId(state.ativo);
Â  const cfg = vend?.cfg || baseCfg;
Â  const $ = id => document.getElementById(id);

Â  if ($('cfg-fixo')) $('cfg-fixo').value = cfg.fixo;
Â  if ($('cfg-m1')) $('cfg-m1').value = cfg.metas[0].alvo;
Â  if ($('cfg-a1')) $('cfg-a1').value = cfg.metas[0].aliq*100;
Â  if ($('cfg-m2')) $('cfg-m2').value = cfg.metas[1].alvo;
Â  if ($('cfg-a2')) $('cfg-a2').value = cfg.metas[1].aliq*100;
Â  if ($('cfg-m3')) $('cfg-m3').value = cfg.metas[2].alvo;
Â  if ($('cfg-a3')) $('cfg-a3').value = cfg.metas[2].aliq*100;
Â  if ($('cfg-pleno')) $('cfg-pleno').value = cfg.pleno;
Â  if ($('cfg-senior')) $('cfg-senior').value = cfg.senior;

Â  document.getElementById('salario-fixo').textContent = fmtBRL(cfg.fixo);
Â  document.getElementById('kpi-fixo').textContent = fmtBRL(cfg.fixo);
}

function saveCfgFromInputs() {
Â  const vend = byId(state.ativo);
Â  if (!vend) return;
Â  const $ = id => Number(document.getElementById(id)?.value || 0);

Â  vend.cfg.fixo = $('cfg-fixo');
Â  vend.cfg.metas[0].alvo = $('cfg-m1');
Â  vend.cfg.metas[0].aliq = $('cfg-a1')/100;
Â  vend.cfg.metas[1].alvo = $('cfg-m2');
Â  vend.cfg.metas[1].aliq = $('cfg-a2')/100;
Â  vend.cfg.metas[2].alvo = $('cfg-m3');
Â  vend.cfg.metas[2].aliq = $('cfg-a3')/100;
Â  vend.cfg.pleno = $('cfg-pleno');
Â  vend.cfg.senior = $('cfg-senior');
Â  save();
}

function attachUIEvents() {
Â  document.querySelectorAll('.nav-btn').forEach(btn =>{
Â  Â  btn.addEventListener('click', ()=>{
Â  Â  Â  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
Â  Â  Â  btn.classList.add('active');
Â  Â  Â  const view = btn.getAttribute('data-view');
Â  Â  Â  document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
Â  Â  Â  document.getElementById('view-'+view).style.display = 'block';
Â  Â  });
Â  });

Â  const periodoSelect = document.getElementById('periodo');
Â  const customRangeDiv = document.getElementById('custom-range');
Â  
Â  const updatePeriodoUI = (p) => {
Â  Â  const dataInicioInput = document.getElementById('data-inicio');
Â  Â  const dataFimInput = document.getElementById('data-fim');
Â  Â  
Â  Â  if (p === 'personalizado') {
Â  Â  Â  if(customRangeDiv) customRangeDiv.style.display = 'flex';
Â  Â  Â  if(dataInicioInput) dataInicioInput.value = state.dataInicio || '';
Â  Â  Â  if(dataFimInput) dataFimInput.value = state.dataFim || '';
Â  Â  } else {
Â  Â  Â  if(customRangeDiv) customRangeDiv.style.display = 'none';
Â  Â  }
Â  };
Â  
Â  if(periodoSelect) periodoSelect.addEventListener('change', (e)=>{
Â  Â  state.periodo = e.target.value;
Â  Â  updatePeriodoUI(state.periodo);
Â  Â  save();
Â  Â  calcular(getScopeFromUI());
Â  });
Â  
Â  updatePeriodoUI(state.periodo);
Â  
Â  const dataInicioInput = document.getElementById('data-inicio');
Â  const dataFimInput = document.getElementById('data-fim');
Â  
Â  const handleDateChange = () => {
Â  Â  if (dataInicioInput) state.dataInicio = dataInicioInput.value;
Â  Â  if (dataFimInput) state.dataFim = dataFimInput.value;
Â  Â  save();
Â  Â  if (state.periodo === 'personalizado') {
Â  Â  Â  calcular(getScopeFromUI());
Â  Â  }
Â  };
Â  
Â  if(dataInicioInput) dataInicioInput.addEventListener('change', handleDateChange);
Â  if(dataFimInput) dataFimInput.addEventListener('change', handleDateChange);
Â  
Â  document.getElementById('filtro-vendedor').addEventListener('change', (e)=>{
Â  Â  calcular(e.target.value);
Â  });

Â  document.getElementById('btn-add').addEventListener('click', ()=>{
Â  Â  const vend = byId(state.ativo);
Â  Â  if (!vend) { alert('Nenhum vendedor ativo. Ative um perfil nas ConfiguraÃ§Ãµes.'); return; }

Â  Â  const cliente = document.getElementById('cliente').value.trim();
Â  Â  const valor = Number(document.getElementById('valor').value || 0);
Â  Â  const data = document.getElementById('data').value || '';

Â  Â  if(!valor || valor<=0){ alert('Informe um valor vÃ¡lido.'); return; }
Â  Â  if(!data){ alert('Informe a data da 1Âª parcela do cliente.'); return; }

Â  Â  vend.vendas.push({cliente, valor, data, status: 'ativo'});
Â  Â  save();
Â  Â  document.getElementById('valor').value = '';
Â  Â  document.getElementById('cliente').value = '';
Â  Â  document.getElementById('data').value = '';
Â  Â  document.getElementById('filtro-vendedor').value = state.ativo;
Â  Â  calcular(state.ativo);
Â  });

Â  document.getElementById('btn-sample').addEventListener('click', ()=>{
Â  Â  const vend = byId(state.ativo);
Â  Â  if (!vend) return;
Â  Â  vend.vendas = [
Â  Â  Â  {cliente:'Alpha SA', valor: 1200000, data: '2025-09-05', status:'ativo'},
Â  Â  Â  {cliente:'Delta PJ', Â valor: 600000, Â data: '2025-06-03', status:'ativo'},
Â  Â  ];
Â  Â  save();
Â  Â  document.getElementById('filtro-vendedor').value = state.ativo;
Â  Â  calcular(state.ativo);
Â  });

Â  document.getElementById('btn-limpar').addEventListener('click', ()=>{
Â  Â  const vend = byId(state.ativo);
Â  Â  if(!vend) return;
Â  Â  if(confirm('Remover todas as vendas do vendedor ativo?')){
Â  Â  Â  vend.vendas = [];
Â  Â  Â  save(); calcular(getScopeFromUI());
Â  Â  }
Â  });

Â  document.getElementById('btn-salvar').addEventListener('click', ()=>{
Â  Â  saveCfgFromInputs();
Â  Â  bindCfgInputsFromActive();
Â  Â  calcular(getScopeFromUI());
Â  Â  alert('ConfiguraÃ§Ãµes salvas para o vendedor ativo.');
Â  });

Â  document.getElementById('btn-resetar').addEventListener('click', ()=>{
Â  Â  if(!confirm('Voltar aos padrÃµes do vendedor ativo?')) return;
Â  Â  const vend = byId(state.ativo);
Â  Â  if (!vend) return;
Â  Â  vend.cfg = structuredClone(baseCfg);
Â  Â  save(); bindCfgInputsFromActive(); calcular(getScopeFromUI());
Â  });

Â  const btnAddVend = document.getElementById('btn-add-vendedor');
Â  const btnAtivar = document.getElementById('btn-ativar-vendedor');
Â  const btnRemover = document.getElementById('btn-remover-vendedor');

Â  btnAddVend?.addEventListener('click', ()=>{
Â  Â  const nome = (document.getElementById('novo-vendedor').value || '').trim();
Â  Â  if(!nome){ alert('Informe o nome do novo vendedor.'); return; }
Â  Â  const novo = { id: crypto.randomUUID(), nome, nivel:'Pleno', cfg: structuredClone(baseCfg), vendas: [] };
Â  Â  state.vendedores.push(novo);
Â  Â  if (!state.ativo) state.ativo = novo.id;
Â  Â  document.getElementById('novo-vendedor').value = '';
Â  Â  save();
Â  Â  renderTopDropdowns();
Â  Â  bindCfgInputsFromActive();
Â  Â  calcular(getScopeFromUI());
Â  Â  alert(`Vendedor "${nome}" criado.`);
Â  });

Â  btnAtivar?.addEventListener('click', ()=>{
Â  Â  const sel = document.getElementById('select-vendedor');
Â  Â  if(!sel?.value) return;
Â  Â  state.ativo = sel.value;
Â  Â  save();
Â  Â  document.getElementById('filtro-vendedor').value = state.ativo;
Â  Â  bindCfgInputsFromActive();
Â  Â  calcular(state.ativo);
Â  });

Â  btnRemover?.addEventListener('click', ()=>{
Â  Â  const sel = document.getElementById('select-vendedor');
Â  Â  const id = sel?.value;
Â  Â  if(!id) return;

Â  Â  if (state.vendedores.length<=1) { alert('NÃ£o Ã© possÃ­vel excluir. Deve existir pelo menos 1 vendedor.'); return; }
Â  Â  if (id === state.ativo) { alert('Troque o vendedor ativo antes de removÃª-lo.'); return; }

Â  Â  const vend = byId(id);
Â  Â  const nome = vend?.nome || 'Vendedor';
Â  Â  state.vendedores = state.vendedores.filter(v => v.id !== id);
Â  Â  save();
Â  Â  renderTopDropdowns();
Â  Â  bindCfgInputsFromActive();
Â  Â  calcular(getScopeFromUI());
Â  Â  alert(`Vendedor "${nome}" removido.`);
Â  });
}

function calcular(scopeOverride) {
Â  const scope = scopeOverride || getScopeFromUI();
Â  renderTopDropdowns();
Â  const selCfg = document.getElementById('select-vendedor');
Â  if (selCfg && selCfg.value !== state.ativo) selCfg.value = state.ativo;
Â  const selPeriodo = document.getElementById('periodo');
Â  if (selPeriodo) {
Â  Â  if (state.periodo === 'trimestral') state.periodo = 'mensal';
Â  Â  if (selPeriodo.value !== state.periodo) selPeriodo.value = state.periodo;
Â  }
Â  
Â  const customRangeDiv = document.getElementById('custom-range');
Â  if (customRangeDiv) {
Â  Â  customRangeDiv.style.display = state.periodo === 'personalizado' ? 'flex' : 'none';
Â  }

Â  renderDashboard(scope);
}

load();
renderTopDropdowns();
bindCfgInputsFromActive();
attachUIEvents();
const topSel = document.getElementById('filtro-vendedor');
if (topSel) topSel.value = 'todos';
document.getElementById('periodo').value = state.periodo;
calcular('todos');
</script>
</body>
</html>


