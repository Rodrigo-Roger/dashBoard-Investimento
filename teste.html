<!-- === PARTE 1/4 — Cabeçalho e estrutura base === -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MontInvestimento • Dashboard de Comissões</title>
  <style>
    :root {
      --ms-navy: #0f2742;
      --ms-blue: #0f4c81;
      --ms-gold: #c6a224;
      --ms-ink: #122033;
      --ms-muted: #6b7280;
      --ms-bg: #f5f7fb;
      --ms-card: #ffffff;
      --ms-border: #e5e7eb;
      --radius: 16px;
      --shadow: 0 10px 25px rgba(15, 39, 66, .08);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--ms-ink);
      background: linear-gradient(180deg, #f8fafc 0%, var(--ms-bg) 100%);
    }

    .app { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
    @media (max-width: 980px) { .app { grid-template-columns: 1fr; } }

    /* Sidebar */
    .sidebar {
      background: linear-gradient(180deg, var(--ms-navy) 0%, #0b1b2e 100%);
      color: #e8eef7;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 36px; height: 36px; border-radius: 10px;
      background: radial-gradient(65% 65% at 30% 30%, #1e3b63 0%, var(--ms-blue) 65%, #0b1b2e 100%);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.05);
    }
    .brand h1 { font-size: 18px; margin: 0; font-weight: 700; }

    nav { display: flex; flex-direction: column; gap: 6px; margin-top: 6px; }
    .nav-btn {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 14px; border-radius: 12px;
      cursor: pointer; border: 1px solid transparent; transition: .2s;
    }
    .nav-btn:hover { background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.08); }
    .nav-btn.active { background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18); }

    .nav-foot { margin-top: auto; font-size: 12px; opacity: .8; }

    /* Main area */
    .main { padding: 28px; }
    .topbar {
      display: flex; flex-wrap: wrap; gap: 16px;
      align-items: center; justify-content: space-between;
      margin-bottom: 20px;
    }
    .title { font-size: 22px; font-weight: 800; }

    .pill {
      display: inline-flex; align-items: center; gap: 10px;
      padding: 8px 12px; border-radius: 999px;
      background: var(--ms-card); border: 1px solid var(--ms-border);
      box-shadow: var(--shadow);
    }

    /* Grid & Cards */
    .grid { display: grid; gap: 18px; }
    .grid.cols-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    @media (max-width: 1180px) { .grid.cols-3 { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 780px) { .grid.cols-3, .grid.cols-2 { grid-template-columns: 1fr; } }

    .card {
      background: var(--ms-card);
      border: 1px solid var(--ms-border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }

    .kpi { display: flex; align-items: flex-end; justify-content: space-between; }
    .kpi .value { font-size: 28px; font-weight: 800; }

    /* Forms */
    label { display: block; font-size: 12px; color: var(--ms-muted); margin-bottom: 6px; }
    input, select {
      width: 100%; padding: 12px;
      border-radius: 12px; border: 1px solid var(--ms-border);
      background: #fff; font-size: 14px; outline: none;
    }
    input:focus, select:focus { border-color: #c7d2fe; box-shadow: 0 0 0 3px rgba(99,102,241,.12); }

    .btn {
      appearance: none; border: none; border-radius: 12px;
      padding: 12px 14px; font-weight: 700; cursor: pointer;
    }
    .btn.primary {
      background: linear-gradient(180deg, var(--ms-blue), #0b2f52);
      color: white; box-shadow: 0 8px 18px rgba(15,76,129,.28);
    }
    .btn.ghost { background: #fff; border: 1px solid var(--ms-border); }
    .btn.gold {
      background: linear-gradient(180deg, #f1d98a, var(--ms-gold));
      color: #1a1a1a; box-shadow: 0 8px 18px rgba(198,162,36,.25);
    }

    /* Progress bars */
    .progress { height: 10px; width: 100%; background: #eef2f7; border-radius: 999px; position: relative; overflow: hidden; }
    .progress > span { position: absolute; top: 0; left: 0; height: 100%; border-radius: 999px; background: linear-gradient(90deg, var(--ms-blue), #1f7fd1); }

    /* Tables */
    table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
    thead th {
      font-size: 12px; text-transform: uppercase;
      letter-spacing: .08em; color: var(--ms-muted);
      text-align: left; padding: 0 12px;
    }
    tbody td {
      background: #fff; border: 1px solid var(--ms-border);
      padding: 12px; vertical-align: middle;
    }
    tbody td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
    tbody td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; }

    .tag {
      font-size: 12px; padding: 6px 10px;
      border-radius: 999px; border: 1px solid var(--ms-border);
      background: #fff;
    }
    .tag.green { border-color: #cce3d1; background: #ecfdf5; }
    .tag.amber { border-color: #f6e7bf; background: #fffbea; }
    .tag.red { border-color: #f5c2c7; background: #fff1f2; }
    .tag.gray { border-color: #e5e7eb; background: #f9fafb; }

    .footnote { font-size: 12px; color: var(--ms-muted); }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <h1>MontInvestimento</h1>
      </div>
      <nav>
        <div class="nav-btn active" data-view="dashboard">📊 Dashboard</div>
        <div class="nav-btn" data-view="vendas">🧾 Vendas</div>
        <div class="nav-btn" data-view="pagamentos">💰 Pagamentos</div>
        <div class="nav-btn" data-view="estornos">↩️ Estornos</div>
        <div class="nav-btn" data-view="config">⚙️ Configurações</div>
      </nav>
      <div class="nav-foot">Versão multi-vendedor • Montseguro 2025</div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">Comissões & Metas</div>
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <div class="pill">
            <label for="filtro-vendedor">Vendedor:</label>
            <select id="filtro-vendedor"></select>
          </div>
          <div class="header-filters">
    <div class="filter-group">
        <label for="periodo">Período:</label>
        <select id="periodo">
            <option value="mensal">Mês Atual</option>
            <option value="personalizado">Personalizado</option> </select>
    </div>
</div>

<div id="custom-range" style="display: none; margin-top: 10px;">
    <div class="filter-group">
        <label for="data-inicio">Início:</label>
        <input type="date" id="data-inicio" value="">
    </div>
    <div class="filter-group" style="margin-left: 10px;">
        <label for="data-fim">Fim:</label>
        <input type="date" id="data-fim" value="">
    </div>
</div>
        </div>
      </div>

      <!-- === PARTE 2/4 — Seções principais do painel === -->

      <!-- === PAINEL FINANCEIRO (CABEÇALHO DE KPIs) === -->
      <div class="grid cols-3" style="margin-bottom:18px">
        <div class="card kpi">
          <div><h3>💵 Salário Fixo</h3><div class="muted">Base mensal</div></div>
          <div class="value" id="salario-fixo">R$ 6.000,00</div>
        </div>
        <div class="card kpi">
          <div><h3>💰 Comissão do Mês</h3><div class="muted">Parcelas pagas</div></div>
          <div class="value" id="comissao-mes">R$ 0,00</div>
        </div>
        <div class="card kpi">
          <div><h3>🔁 Estornos</h3><div class="muted">Cancelamentos do mês</div></div>
          <div class="value" id="estornos-mes">R$ 0,00</div>
        </div>
      </div>

      <div class="card kpi" style="background:linear-gradient(180deg,#e0f2fe,#bae6fd);margin-bottom:24px">
        <div><h3>🧾 Salário Final do Mês</h3><div class="muted">Fixo + Comissão - Estornos</div></div>
        <div class="value" id="salario-final">R$ 6.000,00</div>
      </div>

      <!-- ===== DASHBOARD ===== -->
      <section id="view-dashboard" class="view">
        <div class="grid cols-3">
          <div class="card kpi">
            <div>
              <h3>Salário Fixo</h3>
              <div class="muted" id="kpi-legenda-fixo">base mensal</div>
            </div>
            <div class="value" id="kpi-fixo">R$ 6.000,00</div>
          </div>
          <div class="card kpi">
            <div>
              <h3>Total Vendido</h3>
              <div class="muted" id="kpi-legenda-vendas">no mês atual</div>
            </div>
            <div class="value" id="kpi-vendas">R$ 0,00</div>
          </div>
          <div class="card kpi">
            <div>
              <h3>Comissão</h3>
              <div class="muted" id="kpi-legenda-comissao">alíquota dinâmica</div>
            </div>
            <div class="value" id="kpi-comissao">R$ 0,00</div>
          </div>
        </div>

        <div class="grid cols-2" style="margin-top:18px">
          <div class="card">
            <h3>Metas do Período</h3>
            <div class="row">
              <div>
                <div class="muted">Meta 01 — 0,2% a partir de R$ 2.000.000,00</div>
                <div class="progress" style="margin-top:8px"><span id="bar-m1" style="width:0%"></span></div>
              </div>
              <div style="text-align:right"><span class="tag" id="tag-m1">0%</span></div>
            </div>
            <div class="row" style="margin-top:12px">
              <div>
                <div class="muted">Meta 02 — 0,3% a partir de R$ 3.000.000,00</div>
                <div class="progress" style="margin-top:8px"><span id="bar-m2" style="width:0%"></span></div>
              </div>
              <div style="text-align:right"><span class="tag" id="tag-m2">0%</span></div>
            </div>
            <div class="row" style="margin-top:12px">
              <div>
                <div class="muted">Meta 03 — 0,3% a partir de R$ 4.000.000,00</div>
                <div class="progress" style="margin-top:8px"><span id="bar-m3" style="width:0%"></span></div>
              </div>
              <div style="text-align:right"><span class="tag" id="tag-m3">0%</span></div>
            </div>
          </div>

          <div class="card">
            <h3>Progressão de Cargo</h3>
            <p class="muted">Manutenção Pleno ≥ R$ 7.500.000,00 no trimestre • Promoção para Sênior ≥ R$ 15.000.000,00 no trimestre</p>
            <div class="row" style="margin-top:10px">
              <div>
                <div class="muted">Manter Pleno</div>
                <div class="progress" style="margin-top:8px"><span id="bar-pleno" style="width:0%"></span></div>
              </div>
              <div style="text-align:right"><span class="tag" id="tag-pleno">0%</span></div>
            </div>
            <div class="row" style="margin-top:12px">
              <div>
                <div class="muted">Virar Sênior</div>
                <div class="progress" style="margin-top:8px"><span id="bar-senior" style="width:0%"></span></div>
              </div>
              <div style="text-align:right"><span class="tag" id="tag-senior">0%</span></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <h3>Resumo do Período</h3>
          <div class="grid cols-3">
            <div>
              <div class="muted">Alíquota aplicada</div>
              <div class="value" id="aliquota">0,00%</div>
            </div>
            <div>
              <div class="muted">Comissão estimada</div>
              <div class="value" id="comissao">R$ 0,00</div>
            </div>
            <div>
              <div class="muted">Total (fixo + comissão)</div>
              <div class="value" id="total">R$ 6.000,00</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== VENDAS ===== -->
      <section id="view-vendas" class="view" style="display:none">
        <div class="card">
          <h3>Adicionar Venda</h3>
          <div class="row-3">
            <div>
              <label>Cliente</label>
              <input id="cliente" placeholder="Ex.: ACME Ltda" />
            </div>
            <div>
              <label>Valor do contrato (R$)</label>
              <input id="valor" type="number" min="0" step="0.01" placeholder="0,00" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <label>Data (1ª parcela do cliente)</label>
              <input id="data" type="date" />
            </div>
          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn primary" id="btn-add">Adicionar</button>
            <button class="btn ghost" id="btn-sample">Carregar exemplo</button>
            <button class="btn ghost" id="btn-limpar">Limpar vendas</button>
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <h3>Vendas do período</h3>
          <table id="tabela-vendas">
    <thead>
        <tr>
            <th>Cliente</th> 
            <th>Data</th>    
            <th>Valor</th>   
            <th>Status</th>  
            <th style="text-align:right">Ação</th> </tr>
    </thead>
    <tbody id="tbody-vendas">
    </tbody>
</table>
          <div class="footnote">Obs.: A comissão de cada venda é paga em <b>6 parcelas mensais</b> no dia 10.</div>
        </div>
      </section>

      <!-- ===== PAGAMENTOS ===== -->
      <section id="view-pagamentos" class="view" style="display:none">
        <div class="card">
          <h3>Resumo de Pagamentos</h3>
          <div class="grid cols-3">
            <div><div class="muted">Pagos</div><div class="value" id="pg-pagos">R$ 0,00</div></div>
            <div><div class="muted">Agendados</div><div class="value" id="pg-agendados">R$ 0,00</div></div>
          </div>

          <div class="grid cols-3" style="margin-top:12px">
            <div><div class="muted">Estornos</div><div class="value" id="pg-estornos">R$ 0,00</div></div>
            <div><div class="muted">Líquido</div><div class="value" id="pg-liquido">R$ 0,00</div></div>
            <div><div class="muted">Próximo ciclo</div><div class="value" id="pg-proximo">—</div></div>
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <div class="filter-group" style="display: flex; justify-content: space-between; align-items: center;">
            <h3>Cronograma de Comissões</h3>
            
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="filtro-cronograma">Visualizar Mês:</label>
                <select id="filtro-cronograma">
                </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Mês ref.</th>
                <th>Status</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="tbody-pagamentos"></tbody>
          </table>
        </div>
      </section>

      <!-- ===== ESTORNOS ===== -->
      <section id="view-estornos" class="view" style="display:none">
        <div class="card">
          <h3>Política de Estorno</h3>
          <p class="muted">Cancelamento com menos de 5 parcelas pagas gera estorno das comissões já pagas, mês a mês. Se o cliente pagou 5+, não há estorno e a 6ª é paga normalmente.</p>
        </div>

        <div class="card" style="margin-top:18px">
          <h3>Estornos Automáticos</h3>
          <table>
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Status</th>
                <th>Motivo</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="tbody-estornos"></tbody>
          </table>
          <div class="kpi" style="margin-top:12px">
            <div class="muted">Total de Estornos</div>
            <div class="value" id="estorno-total">R$ 0,00</div>
          </div>
        </div>
      </section>

      <!-- === PARTE 3/4 — Configuração e gerenciamento de vendedores === -->

      <!-- ===== CONFIGURAÇÕES ===== -->
      <section id="view-config" class="view" style="display:none">
        <div class="card">
          <h3>Parâmetros Gerais</h3>
          <div class="row-3">
            <div>
              <label>Salário fixo (R$/mês)</label>
              <input id="cfg-fixo" type="number" min="0" step="0.01" value="6000" />
            </div>
            <div>
              <label>Meta 01 (R$)</label>
              <input id="cfg-m1" type="number" min="0" step="1000" value="2000000" />
            </div>
            <div>
              <label>Aliq. Meta 01 (%)</label>
              <input id="cfg-a1" type="number" min="0" step="0.01" value="0.2" />
            </div>
          </div>

          <div class="row-3" style="margin-top:12px">
            <div>
              <label>Meta 02 (R$)</label>
              <input id="cfg-m2" type="number" min="0" step="1000" value="3000000" />
            </div>
            <div>
              <label>Aliq. Meta 02 (%)</label>
              <input id="cfg-a2" type="number" min="0" step="0.01" value="0.3" />
            </div>
            <div>
              <label>Meta 03 (R$)</label>
              <input id="cfg-m3" type="number" min="0" step="1000" value="4000000" />
            </div>
          </div>

          <div class="row-3" style="margin-top:12px">
            <div>
              <label>Aliq. Meta 03 (%)</label>
              <input id="cfg-a3" type="number" min="0" step="0.01" value="0.3" />
            </div>
            <div>
              <label>Trimestre: Manter Pleno (R$)</label>
              <input id="cfg-pleno" type="number" min="0" step="1000" value="7500000" />
            </div>
            <div>
              <label>Trimestre: Virar Sênior (R$)</label>
              <input id="cfg-senior" type="number" min="0" step="1000" value="15000000" />
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn primary" id="btn-salvar">Salvar</button>
            <button class="btn ghost" id="btn-resetar">Resetar padrões</button>
          </div>
        </div>

        <!-- NOVO BLOCO: GERENCIAMENTO DE VENDEDORES -->
        <div class="card" style="margin-top:18px">
          <h3>Perfis de Vendedores</h3>
          <p class="muted">Cada vendedor tem vendas, metas e estornos próprios. Escolha o vendedor ativo para atualizar os dados exibidos no dashboard.</p>

          <div class="row">
            <div>
              <label>Selecionar vendedor ativo</label>
              <select id="select-vendedor"></select>
            </div>
            <div>
              <label>Nome do novo vendedor</label>
              <input id="novo-vendedor" type="text" placeholder="Ex.: João Silva" />
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn primary" id="btn-add-vendedor">Criar vendedor</button>
            <button class="btn gold" id="btn-ativar-vendedor">Ativar selecionado</button>
            <button class="btn ghost" id="btn-remover-vendedor">Excluir selecionado</button>
          </div>

          <div class="footnote" style="margin-top:8px">
            • Ao ativar um vendedor, o dashboard mostrará apenas suas vendas, comissões e estornos.  
            • O vendedor <b>Angelo</b> (Pleno) é criado automaticamente como perfil padrão.
          </div>
        </div>
      </section>

      <!-- FIM DAS SEÇÕES PRINCIPAIS -->
    </main>
  </div>

  <!-- Script vem na parte 4 -->

  <!-- === PARTE 4/4 — Script completo (multi-vendedor + período + estornos) === -->
<script>
const fmtBRL = v => (Number(v)||0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
const pct = v => `${(v*100).toFixed(2).replace('.',',')}%`;
const parseISO = s => s ? new Date(s + 'T00:00:00') : null;
const DIA_PAGAMENTO = 10;

const structuredClone = (obj) => JSON.parse(JSON.stringify(obj)); 

const baseCfg = {
  fixo: 6000,
  metas: [
    { alvo: 2000000, aliq: 0.002 }, 
    { alvo: 3000000, aliq: 0.003 }, 
    { alvo: 4000000, aliq: 0.003 }, 
  ],
  pleno: 7500000,
  senior: 15000000,
};

const STORAGE_KEY = 'ms-multi-vendedores-2025';

const state = {
  vendedores: [],
  ativo: null,       
  periodo: 'mensal', 
  dataInicio: null, 
  dataFim: null,
  filtroCronograma: null, 
};

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function load() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) {
    const angelo = {
      id: crypto.randomUUID(),
      nome: 'Angelo',
      nivel: 'Pleno',
      cfg: structuredClone(baseCfg),
      vendas: []
    };
    state.vendedores = [angelo];
    state.ativo = angelo.id;
    state.periodo = 'mensal';
    
    const hoje = new Date();
    state.filtroCronograma = `${hoje.getFullYear()}-${hoje.getMonth()}`; 
    
    state.dataInicio = null;
    state.dataFim = null;
    
    save();
    return;
  }
  try {
    const s = JSON.parse(raw);
    if (!Array.isArray(s.vendedores) || !s.vendedores.length) {
      const angelo = {
        id: crypto.randomUUID(),
        nome: 'Angelo',
        nivel: 'Pleno',
        cfg: structuredClone(baseCfg),
        vendas: []
      };
      state.vendedores = [angelo];
      state.ativo = angelo.id;
      state.periodo = 'mensal';
    } else {
      Object.assign(state, s);
    }
    
    if (!state.filtroCronograma) {
      const hoje = new Date();
      state.filtroCronograma = `${hoje.getFullYear()}-${hoje.getMonth()}`;
    }
    if (state.periodo === 'trimestral') state.periodo = 'mensal';
    if (state.dataInicio === undefined) state.dataInicio = null;
    if (state.dataFim === undefined) state.dataFim = null;
    
  } catch(e) {
    console.error(e);
  }
}

const byId = id => state.vendedores.find(v => v.id === id) || null;

function getScopeFromUI() {
  const sel = document.getElementById('filtro-vendedor');
  return sel?.value || 'todos';
}

function getScopeVendas(scope) {
  if (scope === 'todos') {
    return state.vendedores.flatMap(v => v.vendas.map(x => ({...x, _owner:v.id})));
  }
  const vend = byId(scope);
  return vend ? vend.vendas.map(x => ({...x, _owner: vend.id})) : [];
}

function getPeriodoInterval() {
  const hoje = new Date();
  
  const fimPadrao = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate() + 1, 0, 0, 0, 0); 

  if (state.periodo === 'personalizado' && state.dataInicio && state.dataFim) {
    const inicio = parseISO(state.dataInicio);
    const fimPersonalizado = new Date(parseISO(state.dataFim));
    fimPersonalizado.setDate(fimPersonalizado.getDate() + 1);
    
    if(inicio && fimPersonalizado){
      return { inicio, fim: fimPersonalizado };
    }
  } 
  
  const inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1, 0, 0, 0, 0);
  return { inicio, fim: fimPadrao };
}

function filtrarVendasPorPeriodo(vendas) {
  const { inicio, fim } = getPeriodoInterval();
  if (!inicio || !fim) return vendas; 
  
  return vendas.filter(v => {
    const d = parseISO(v.data);
    return d && d >= inicio && d <= fim;
  });
}

function totalVendido(vendas) {
  return vendas.reduce((acc, v) => acc + Number(v.valor||0), 0);
}

function aliquotaAplicavel(total, metas) {
  let aliq = 0;
  if (total >= metas[2].alvo) aliq = metas[2].aliq; 
  else if (total >= metas[1].alvo) aliq = metas[1].aliq;
  else if (total >= metas[0].alvo) aliq = metas[0].aliq;
  return aliq;
}

function dataComissaoParcela(venda, i){
  const start = parseISO(venda.data) || new Date();
  const d = new Date(start);
  d.setMonth(d.getMonth() + i);
  d.setDate(DIA_PAGAMENTO);
  return d;
}

function expectedClientePagasAte(venda, refDate){
  const start = parseISO(venda.data) || new Date();
  const vencDia = start.getDate();
  let count = 0;
  for(let k=0; k<venda.parcelas; k++){
    const due = new Date(start);
    due.setMonth(due.getMonth() + k);
    due.setDate(vencDia);
    if(due <= refDate) count++;
  }
  return count;
}

function cronogramaComissaoVenda(venda, comissaoVenda){
  const today = new Date();
  const cancelAt = venda.status === 'cancelado' && venda.cancelamento ? parseISO(venda.cancelamento) : null;
  const pagasCliente = Number(venda.pagas||0);
  const parcelas = [];

  for(let i=1;i<=6;i++){
    const when = dataComissaoParcela(venda, i);
    let status = 'agendado';

    if(cancelAt && cancelAt <= when){
      if(pagasCliente >= 5){
        status = (when <= today) ? 'pago' : 'agendado';
      } else {
        status = 'cancelado';
      }
    } else {
      if(when <= today){
        const esperadas = expectedClientePagasAte(venda, when);
        const inadimplente = (Number(venda.pagas||0) < Math.min(esperadas, venda.parcelas));
        
        if(inadimplente && pagasCliente < 5){
          status = 'inadimplente'; 
        } else {
          status = 'pago'; 
        }
      } else {
        status = 'agendado';
      }
    }

    let statusFinal = status;
    if (venda.cronograma_manual && venda.cronograma_manual[i-1]) {
      statusFinal = venda.cronograma_manual[i-1];
      if (statusFinal === 'suspenso') statusFinal = 'inadimplente';
    }

    parcelas.push({ data: when, status: statusFinal, valor: comissaoVenda/6 });
  }
  return parcelas;
}

function gerarEstornosPosCancelamento(venda, cronograma){
  const estornos = [];
  if(venda.status !== 'cancelado' || !venda.cancelamento) return estornos;

  const pagasCliente = Number(venda.pagas||0);
  if(pagasCliente >= 5) return estornos;

  const cancelAt = parseISO(venda.cancelamento);
  const pagasAntes = cronograma.filter(p => p.status === 'pago' && p.data < cancelAt);
  if(pagasAntes.length === 0) return estornos;

  const start = new Date(cancelAt);
  if(start.getDate() > DIA_PAGAMENTO){ start.setMonth(start.getMonth()+1); }
  start.setDate(DIA_PAGAMENTO);

  for(let i=0;i<pagasAntes.length;i++){
    const d = new Date(start);
    d.setMonth(d.getMonth()+i);
    estornos.push({ data: d, status: 'estorno', valor: pagasAntes[0].valor });
  }
  return estornos;
}

function generateMonthOptions() {
  const sel = document.getElementById('filtro-cronograma');
  if (!sel) return;

  sel.innerHTML = '';
  
  const hoje = new Date();
  const mesAtual = hoje.getMonth();
  const anoAtual = hoje.getFullYear();
  
  for (let i = -12; i <= 12; i++) { 
    const d = new Date(anoAtual, mesAtual + i, 1);
    const mes = d.getMonth();
    const ano = d.getFullYear();
    const value = `${ano}-${mes}`; 
    
    const opt = document.createElement('option');
    opt.value = value;
    opt.textContent = d.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
    sel.appendChild(opt);
  }
  
  sel.value = state.filtroCronograma;
  
  sel.onchange = (e) => {
    state.filtroCronograma = e.target.value;
    save();
    calcular(getScopeFromUI());
  };
}

function renderTopDropdowns() {
  const sel = document.getElementById('filtro-vendedor');
  if (!sel) return;
  const current = sel.value || 'todos';
  sel.innerHTML = '';
  const optAll = document.createElement('option');
  optAll.value = 'todos';
  optAll.textContent = 'Todos (geral)';
  sel.appendChild(optAll);

  state.vendedores.forEach(v => {
    const o = document.createElement('option');
    o.value = v.id;
    o.textContent = `${v.nome} (${v.nivel})`;
    sel.appendChild(o);
  });

  sel.value = current;
  if (!sel.value) sel.value = 'todos';

  const selCfg = document.getElementById('select-vendedor');
  if (selCfg) {
    selCfg.innerHTML = '';
    state.vendedores.forEach(v => {
      const o = document.createElement('option');
      o.value = v.id;
      o.textContent = `${v.nome} (${v.nivel})`;
      selCfg.appendChild(o);
    });
    selCfg.value = state.ativo || (state.vendedores[0]?.id || '');
  }
  
  generateMonthOptions();
}

function renderVendasTable(vendasEscopo) {
  const tbody = document.getElementById('tbody-vendas');
  if(!tbody) return;
  tbody.innerHTML = '';

  const vendasPeriodo = filtrarVendasPorPeriodo(vendasEscopo); 
  
  vendasPeriodo.forEach((v, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${v.cliente||'-'}</td>
      <td>${v.data||'-'}</td>
      <td><b>${fmtBRL(Number(v.valor||0))}</b></td>
      <td>${v.status||'ativo'}</td>
      <td style="text-align:right"><button class="btn gold" data-del="${idx}">Excluir</button></td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('button[data-del]').forEach((btn, visualIdx) => {
    btn.addEventListener('click', () => {
      const scope = getScopeFromUI();
      if (scope === 'todos') {
        alert('Troque o filtro para um vendedor específico para excluir vendas.');
        return;
      }
      const vend = byId(scope);
      if (!vend) return;
      const vendasVisuais = filtrarVendasPorPeriodo(vend.vendas); 
      const vendaVisual = vendasVisuais[visualIdx];
      if (!vendaVisual) return;
      
      const idxReal = vend.vendas.findIndex(x =>
        x.cliente===vendaVisual.cliente &&
        x.data===vendaVisual.data &&
        x.valor===vendaVisual.valor 
      );
      if (idxReal>=0) {
        vend.vendas.splice(idxReal,1);
      }
      save();
      calcular(scope);
    });
  });
}

function renderPagamentosEEstornos(scope, metasRef) {
  const tbPay = document.getElementById('tbody-pagamentos');
  const tbEst = document.getElementById('tbody-estornos');
  const lblEPagos = document.getElementById('pg-pagos');
  const lblEInad = document.getElementById('pg-inadimplentes'); 
  const lblEAgend = document.getElementById('pg-agendados');
  const lblEEst = document.getElementById('pg-estornos');
  const lblELiq = document.getElementById('pg-liquido');
  const lblNext = document.getElementById('pg-proximo');
  const lblEstTotal = document.getElementById('estorno-total');

  if (tbPay) tbPay.innerHTML = '';
  if (tbEst) tbEst.innerHTML = '';

  const [anoFiltro, mesFiltro] = state.filtroCronograma.split('-').map(Number);
  
  const vendasEscopo = getScopeVendas(scope);
  const totalVendasDoEscopo = totalVendido(vendasEscopo); 
  const aliqDoEscopo = aliquotaAplicavel(totalVendasDoEscopo, metasRef);
  const comissaoTotalDoEscopo = totalVendasDoEscopo * aliqDoEscopo;

  let somaPagos = 0, somaInadimplentes = 0, somaAgendados = 0, somaEstornos = 0;

  const hoje = new Date(); 
  const mesAtual = hoje.getMonth();
  const anoAtual = hoje.getFullYear();

  let comissaoMesKPI = 0; 
  let estornosMesKPI = 0; 

  vendasEscopo.forEach((v, vIdx) => {
    const peso = totalVendasDoEscopo > 0 ? (Number(v.valor || 0) / totalVendasDoEscopo) : 0;
    const comissaoVenda = comissaoTotalDoEscopo * peso;
    
    const cron = cronogramaComissaoVenda(v, comissaoVenda);
    const est = gerarEstornosPosCancelamento(v, cron);

    cron.forEach(p => {
      const ehMesAtual = p.data.getMonth() === mesAtual && p.data.getFullYear() === anoAtual;
      if (ehMesAtual && (p.status === 'pago' || p.status === 'agendado')) { 
        comissaoMesKPI += p.valor;
      }
    });
    
    est.forEach(ei => {
      const ehMesAtual = ei.data.getMonth() === mesAtual && ei.data.getFullYear() === anoAtual;
      if (ehMesAtual) estornosMesKPI += ei.valor;
    });

    if (tbPay){
      cron.forEach((p, i)=>{
        const ehMesSelecionado = p.data.getMonth() === mesFiltro && p.data.getFullYear() === anoFiltro;
        const statusRelevante = (p.status !== 'cancelado'); 

        if (!ehMesSelecionado || !statusRelevante) {
          return; 
        }

        if(p.status==='pago'){ somaPagos += p.valor; }
        if(p.status==='inadimplente'){ somaInadimplentes += p.valor; } 
        if(p.status==='agendado'){ somaAgendados += p.valor; }

        const statusSelect = `
            <select class="status-select" data-venda-idx="${vIdx}" data-parcela-idx="${i}">
                <option value="pago" ${p.status === 'pago' ? 'selected' : ''}>Pago</option>
                <option value="agendado" ${p.status === 'agendado' ? 'selected' : ''}>Agendado</option>
                <option value="inadimplente" ${p.status === 'inadimplente' ? 'selected' : ''}>Inadimplente</option>
                <option value="cancelado" ${p.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
            </select>
        `;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${v.cliente||'-'}</td>
          <td>${p.data.toLocaleDateString('pt-BR', {month:'2-digit', year:'numeric'})}</td>
          <td>${statusSelect}</td> 
          <td class="valor"><b>${fmtBRL(p.valor)}</b></td>
        `;
        tbPay.appendChild(tr);
      });
    }

    if (tbEst && est.length){
      est.forEach(ei=>{
        const ehMesSelecionado = ei.data.getMonth() === mesFiltro && ei.data.getFullYear() === anoFiltro;
        
        if (!ehMesSelecionado) return;
        
        somaEstornos += ei.valor;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${v.cliente||'-'}</td>
          <td>${parseISO(v.cancelamento).toLocaleDateString('pt-BR')}</td>
          <td><span class="tag red">Estorno</span></td>
          <td class="valor"><b>${fmtBRL(ei.valor)}</b></td>
        `;
        tbEst.appendChild(tr);
      });
    }

  });

  const proximo10 = (() => {
    const t = new Date();
    if(t.getDate() > DIA_PAGAMENTO){ t.setMonth(t.getMonth()+1); }
    t.setDate(DIA_PAGAMENTO);
    return t;
  })();

  if(lblEPagos) lblEPagos.textContent = fmtBRL(somaPagos);
  if(lblEInad) lblEInad.textContent = fmtBRL(somaInadimplentes); 
  if(lblEAgend) lblEAgend.textContent = fmtBRL(somaAgendados);
  if(lblEEst) lblEEst.textContent = fmtBRL(somaEstornos);
  if(lblELiq) lblELiq.textContent = fmtBRL(Math.max(0, somaPagos + somaAgendados - somaEstornos)); 
  if(lblNext) lblNext.textContent = proximo10.toLocaleDateString('pt-BR');
  if(lblEstTotal) lblEstTotal.textContent = fmtBRL(somaEstornos);
  
  document.getElementById('comissao-mes').textContent = fmtBRL(comissaoMesKPI);
  document.getElementById('estornos-mes').textContent = fmtBRL(estornosMesKPI);

  let salarioFixo = 0;
  if (scope === 'todos') salarioFixo = state.vendedores.reduce((acc,v)=>acc+(Number(v.cfg?.fixo)||0),0);
  else salarioFixo = Number(byId(scope)?.cfg?.fixo) || 0;

  const salarioFinal = salarioFixo + comissaoMesKPI - estornosMesKPI;

  document.getElementById('salario-fixo').textContent = fmtBRL(salarioFixo);
  document.getElementById('salario-final').textContent = fmtBRL(salarioFinal);
   
    if (tbPay) {
      tbPay.querySelectorAll('.status-select').forEach(select => {
          select.addEventListener('change', (e) => {
              const novoStatus = e.target.value;
              const parcelaIdx = parseInt(e.target.dataset.parcelaIdx); 
              const visualIdx = parseInt(e.target.dataset.vendaIdx); 
              
              const vendaAfetada = vendasEscopo[visualIdx]; 
              
              if (!vendaAfetada) return;
              
              const vendOwner = byId(vendaAfetada._owner);
              const realIndex = vendOwner.vendas.findIndex(v => v.cliente === vendaAfetada.cliente && v.data === vendaAfetada.data);
              
              if (realIndex >= 0) {
                  const vendaNoState = vendOwner.vendas[realIndex];
                  
                  if (!vendaNoState.cronograma_manual) {
                      const cronAuto = cronogramaComissaoVenda(vendaNoState, 1); 
                      vendaNoState.cronograma_manual = cronAuto.map(p => p.status === 'suspenso' ? 'inadimplente' : p.status);
                  }
                  
                  vendaNoState.cronograma_manual[parcelaIdx] = novoStatus;
                  
                  save();
                  calcular(getScopeFromUI());
              }
          });
      });
    }
}

function renderDashboard(scope) {
  const vendasEscopo = getScopeVendas(scope);
  const vendasPeriodo = filtrarVendasPorPeriodo(vendasEscopo); 

  let cfgRef = structuredClone(baseCfg);
  if (scope !== 'todos') {
    const vend = byId(scope);
    if (vend) cfgRef = vend.cfg || structuredClone(baseCfg);
  }

  const total = totalVendido(vendasPeriodo);
  const aliq = aliquotaAplicavel(total, cfgRef.metas);
  const comissaoTotal = total * aliq;

  const fixo = (scope==='todos')
    ? state.vendedores.reduce((acc,v)=>acc+(Number(v.cfg?.fixo)||0),0)
    : Number(byId(scope)?.cfg?.fixo) || baseCfg.fixo;

  document.getElementById('kpi-vendas').textContent = fmtBRL(total);
  document.getElementById('kpi-comissao').textContent = fmtBRL(comissaoTotal);
  document.getElementById('kpi-fixo').textContent = fmtBRL(fixo);
  
  let legenda = 'no período atual';
  if (state.periodo === 'mensal') legenda = 'no Mês Atual';
  else if (state.periodo === 'personalizado') legenda = 'no Período Personalizado';
  document.getElementById('kpi-legenda-vendas').textContent = legenda;
  
  document.getElementById('kpi-legenda-comissao').textContent = aliq? `alíquota ${pct(aliq)}`:'sem meta atingida';
  document.getElementById('kpi-legenda-fixo').textContent = scope==='todos' ? 'soma dos fixos' : 'base mensal';

  const metas = cfgRef.metas;
  const bars = ['bar-m1','bar-m2','bar-m3'];
  const tags = ['tag-m1','tag-m2','tag-m3'];
  metas.forEach((m, i) => {
    const perc = m.alvo>0 ? Math.min(100, Math.round((total / m.alvo) * 100)) : 0;
    const bar = document.getElementById(bars[i]);
    const tag = document.getElementById(tags[i]);
    if (bar) bar.style.width = perc + '%';
    if (tag) {
      tag.textContent = perc + '%';
      tag.className = 'tag ' + (perc>=100? 'green': (perc>=50?'amber':'')) || 'tag';
    }
  });

  const ref = total;
  const plenoPerc = cfgRef.pleno>0 ? Math.min(100, Math.round((ref / cfgRef.pleno) * 100)) : 0;
  const seniorPerc = cfgRef.senior>0 ? Math.min(100, Math.round((ref / cfgRef.senior) * 100)) : 0;
  document.getElementById('bar-pleno').style.width = plenoPerc + '%';
  document.getElementById('tag-pleno').textContent = plenoPerc + '%';
  document.getElementById('tag-pleno').className = 'tag ' + (plenoPerc>=100?'green': (plenoPerc>=50?'amber':'')) || 'tag';
  document.getElementById('bar-senior').style.width = seniorPerc + '%';
  document.getElementById('tag-senior').textContent = seniorPerc + '%';
  document.getElementById('tag-senior').className = 'tag ' + (seniorPerc>=100?'green': (seniorPerc>=50?'amber':'')) || 'tag';

  document.getElementById('aliquota').textContent = pct(aliq||0);
  document.getElementById('comissao').textContent = fmtBRL(comissaoTotal);

  const totalFixo = (scope==='todos')
    ? state.vendedores.reduce((acc,v)=>acc+(Number(v.cfg?.fixo)||0),0)
    : Number(byId(scope)?.cfg?.fixo) || 0;
  document.getElementById('total').textContent = fmtBRL(totalFixo + comissaoTotal);

  renderVendasTable(vendasEscopo); 
  renderPagamentosEEstornos(scope, cfgRef.metas);
}

function bindCfgInputsFromActive() {
  const vend = byId(state.ativo);
  const cfg = vend?.cfg || baseCfg;
  const $ = id => document.getElementById(id);

  if ($('cfg-fixo')) $('cfg-fixo').value = cfg.fixo;
  if ($('cfg-m1')) $('cfg-m1').value = cfg.metas[0].alvo;
  if ($('cfg-a1')) $('cfg-a1').value = cfg.metas[0].aliq*100;
  if ($('cfg-m2')) $('cfg-m2').value = cfg.metas[1].alvo;
  if ($('cfg-a2')) $('cfg-a2').value = cfg.metas[1].aliq*100;
  if ($('cfg-m3')) $('cfg-m3').value = cfg.metas[2].alvo;
  if ($('cfg-a3')) $('cfg-a3').value = cfg.metas[2].aliq*100;
  if ($('cfg-pleno')) $('cfg-pleno').value = cfg.pleno;
  if ($('cfg-senior')) $('cfg-senior').value = cfg.senior;

  document.getElementById('salario-fixo').textContent = fmtBRL(cfg.fixo);
  document.getElementById('kpi-fixo').textContent = fmtBRL(cfg.fixo);
}

function saveCfgFromInputs() {
  const vend = byId(state.ativo);
  if (!vend) return;
  const $ = id => Number(document.getElementById(id)?.value || 0);

  vend.cfg.fixo = $('cfg-fixo');
  vend.cfg.metas[0].alvo = $('cfg-m1');
  vend.cfg.metas[0].aliq = $('cfg-a1')/100;
  vend.cfg.metas[1].alvo = $('cfg-m2');
  vend.cfg.metas[1].aliq = $('cfg-a2')/100;
  vend.cfg.metas[2].alvo = $('cfg-m3');
  vend.cfg.metas[2].aliq = $('cfg-a3')/100;
  vend.cfg.pleno = $('cfg-pleno');
  vend.cfg.senior = $('cfg-senior');
  save();
}

function attachUIEvents() {
  document.querySelectorAll('.nav-btn').forEach(btn =>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const view = btn.getAttribute('data-view');
      document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
      document.getElementById('view-'+view).style.display = 'block';
    });
  });

  const periodoSelect = document.getElementById('periodo');
  const customRangeDiv = document.getElementById('custom-range');
  
  const updatePeriodoUI = (p) => {
    const dataInicioInput = document.getElementById('data-inicio');
    const dataFimInput = document.getElementById('data-fim');
    
    if (p === 'personalizado') {
      if(customRangeDiv) customRangeDiv.style.display = 'flex';
      if(dataInicioInput) dataInicioInput.value = state.dataInicio || '';
      if(dataFimInput) dataFimInput.value = state.dataFim || '';
    } else {
      if(customRangeDiv) customRangeDiv.style.display = 'none';
    }
  };
  
  if(periodoSelect) periodoSelect.addEventListener('change', (e)=>{
    state.periodo = e.target.value;
    updatePeriodoUI(state.periodo);
    save();
    calcular(getScopeFromUI());
  });
  
  updatePeriodoUI(state.periodo);
  
  const dataInicioInput = document.getElementById('data-inicio');
  const dataFimInput = document.getElementById('data-fim');
  
  const handleDateChange = () => {
    if (dataInicioInput) state.dataInicio = dataInicioInput.value;
    if (dataFimInput) state.dataFim = dataFimInput.value;
    save();
    if (state.periodo === 'personalizado') {
      calcular(getScopeFromUI());
    }
  };
  
  if(dataInicioInput) dataInicioInput.addEventListener('change', handleDateChange);
  if(dataFimInput) dataFimInput.addEventListener('change', handleDateChange);
  
  document.getElementById('filtro-vendedor').addEventListener('change', (e)=>{
    calcular(e.target.value);
  });

  document.getElementById('btn-add').addEventListener('click', ()=>{
    const vend = byId(state.ativo);
    if (!vend) { alert('Nenhum vendedor ativo. Ative um perfil nas Configurações.'); return; }

    const cliente = document.getElementById('cliente').value.trim();
    const valor = Number(document.getElementById('valor').value || 0);
    const data = document.getElementById('data').value || '';

    if(!valor || valor<=0){ alert('Informe um valor válido.'); return; }
    if(!data){ alert('Informe a data da 1ª parcela do cliente.'); return; }

    vend.vendas.push({cliente, valor, data, status: 'ativo'});
    save();
    document.getElementById('valor').value = '';
    document.getElementById('cliente').value = '';
    document.getElementById('data').value = '';
    document.getElementById('filtro-vendedor').value = state.ativo;
    calcular(state.ativo);
  });

  document.getElementById('btn-sample').addEventListener('click', ()=>{
    const vend = byId(state.ativo);
    if (!vend) return;
    vend.vendas = [
      {cliente:'Alpha SA', valor: 1200000, data: '2025-09-05', status:'ativo'},
      {cliente:'Delta PJ',  valor: 600000,  data: '2025-06-03', status:'ativo'},
    ];
    save();
    document.getElementById('filtro-vendedor').value = state.ativo;
    calcular(state.ativo);
  });

  document.getElementById('btn-limpar').addEventListener('click', ()=>{
    const vend = byId(state.ativo);
    if(!vend) return;
    if(confirm('Remover todas as vendas do vendedor ativo?')){
      vend.vendas = [];
      save(); calcular(getScopeFromUI());
    }
  });

  document.getElementById('btn-salvar').addEventListener('click', ()=>{
    saveCfgFromInputs();
    bindCfgInputsFromActive();
    calcular(getScopeFromUI());
    alert('Configurações salvas para o vendedor ativo.');
  });

  document.getElementById('btn-resetar').addEventListener('click', ()=>{
    if(!confirm('Voltar aos padrões do vendedor ativo?')) return;
    const vend = byId(state.ativo);
    if (!vend) return;
    vend.cfg = structuredClone(baseCfg);
    save(); bindCfgInputsFromActive(); calcular(getScopeFromUI());
  });

  const btnAddVend = document.getElementById('btn-add-vendedor');
  const btnAtivar = document.getElementById('btn-ativar-vendedor');
  const btnRemover = document.getElementById('btn-remover-vendedor');

  btnAddVend?.addEventListener('click', ()=>{
    const nome = (document.getElementById('novo-vendedor').value || '').trim();
    if(!nome){ alert('Informe o nome do novo vendedor.'); return; }
    const novo = { id: crypto.randomUUID(), nome, nivel:'Pleno', cfg: structuredClone(baseCfg), vendas: [] };
    state.vendedores.push(novo);
    if (!state.ativo) state.ativo = novo.id;
    document.getElementById('novo-vendedor').value = '';
    save();
    renderTopDropdowns();
    bindCfgInputsFromActive();
    calcular(getScopeFromUI());
    alert(`Vendedor "${nome}" criado.`);
  });

  btnAtivar?.addEventListener('click', ()=>{
    const sel = document.getElementById('select-vendedor');
    if(!sel?.value) return;
    state.ativo = sel.value;
    save();
    document.getElementById('filtro-vendedor').value = state.ativo;
    bindCfgInputsFromActive();
    calcular(state.ativo);
  });

  btnRemover?.addEventListener('click', ()=>{
    const sel = document.getElementById('select-vendedor');
    const id = sel?.value;
    if(!id) return;

    if (state.vendedores.length<=1) { alert('Não é possível excluir. Deve existir pelo menos 1 vendedor.'); return; }
    if (id === state.ativo) { alert('Troque o vendedor ativo antes de removê-lo.'); return; }

    const vend = byId(id);
    const nome = vend?.nome || 'Vendedor';
    state.vendedores = state.vendedores.filter(v => v.id !== id);
    save();
    renderTopDropdowns();
    bindCfgInputsFromActive();
    calcular(getScopeFromUI());
    alert(`Vendedor "${nome}" removido.`);
  });
}

function calcular(scopeOverride) {
  const scope = scopeOverride || getScopeFromUI();
  renderTopDropdowns();
  const selCfg = document.getElementById('select-vendedor');
  if (selCfg && selCfg.value !== state.ativo) selCfg.value = state.ativo;
  const selPeriodo = document.getElementById('periodo');
  if (selPeriodo) {
    if (state.periodo === 'trimestral') state.periodo = 'mensal';
    if (selPeriodo.value !== state.periodo) selPeriodo.value = state.periodo;
  }
  
  const customRangeDiv = document.getElementById('custom-range');
  if (customRangeDiv) {
    customRangeDiv.style.display = state.periodo === 'personalizado' ? 'flex' : 'none';
  }

  renderDashboard(scope);
}

load();
renderTopDropdowns();
bindCfgInputsFromActive();
attachUIEvents();
const topSel = document.getElementById('filtro-vendedor');
if (topSel) topSel.value = 'todos';
document.getElementById('periodo').value = state.periodo;
calcular('todos');
</script>
</body>
</html>


